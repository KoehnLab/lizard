name: Static analysis

on: pull_request

jobs:
  clang-tidy:
    runs-on: ubuntu-latest
    steps:
        - name: Checkout
          uses: actions/checkout@v3
          with:
              fetch-depth: 1
              submodules: 'recursive'

        - name: Install dependencies
          run: sudo apt install clang-tidy uuid-dev
          shell: bash

        - name: Setup Java
          uses: actions/setup-java@v3
          with:
              java-version: 11
              distribution: 'temurin'

          # As we depend on code generation, we have to build the project here in order to ensure all
          # required include files have been produced.
        - name: Build
          uses: lukka/run-cmake@v3
          with:
              cmakeListsOrSettingsJson: 'CMakeListsTxtAdvanced' # Required to respect cmakeAppendedArgs
              cmakeBuildType: Debug
              buildDirectory: 'build'
              cmakeAppendedArgs: -DLIZARD_LWYU=OFF -DLIZARD_IWYU=OFF -DLIZARD_CLANG_TIDY=OFF -DLIZARD_BUILD_TESTS=OFF

        - name: Create results directory
          run: mkdir clang-tidy-result
          shell: bash

        - name: Analyze
          run:  run-clang-tidy "$(pwd)/src/" "$(pwd)/include/" -export-fixes clang-tidy-result/fixes.yml -p build
          shell: bash

        - name: Save PR metadata
          run: |
            echo ${{ github.event.number }} > clang-tidy-result/pr-id.txt
            echo ${{ github.event.pull_request.head.repo.full_name }} > clang-tidy-result/pr-head-repo.txt
            echo ${{ github.event.pull_request.head.ref }} > clang-tidy-result/pr-head-ref.txt

        - uses: actions/upload-artifact@v3
          with:
            name: clang-tidy-result
            path: clang-tidy-result/
